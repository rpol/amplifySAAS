{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/apps/web/src/lib/auth.ts"],"sourcesContent":["export const SESSION_COOKIE_NAME = \"amplify_session\";\n\nexport const DEFAULT_AUTH_REDIRECT = \"/dashboard/default\";\n\nexport const AUTH_API_BASE_URL =\n  process.env.NEXT_PUBLIC_API_URL ??\n  process.env.AUTH_API_URL ??\n  \"http://localhost:3001\";\n\nexport interface AuthResponse {\n  token: string;\n  expiresAt: string;\n  maxAge: number;\n  user: {\n    id: string;\n    email: string;\n    name: string;\n  };\n}\n\nexport function calculateCookieMaxAge(\n  expiresAt: string,\n  fallbackSeconds = 60 * 60 * 24 * 7,\n): number {\n  const expiresAtDate = new Date(expiresAt);\n  const diff = Math.floor((expiresAtDate.getTime() - Date.now()) / 1000);\n  return Number.isFinite(diff) && diff > 0 ? diff : fallbackSeconds;\n}\n\nexport function resolveRedirectPath(path?: string | null): string {\n  if (!path) return DEFAULT_AUTH_REDIRECT;\n  if (!path.startsWith(\"/\")) return DEFAULT_AUTH_REDIRECT;\n  if (path.startsWith(\"//\")) return DEFAULT_AUTH_REDIRECT;\n  if (path.startsWith(\"/auth\")) return DEFAULT_AUTH_REDIRECT;\n  return path;\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAAO,MAAM,sBAAsB;AAE5B,MAAM,wBAAwB;AAE9B,MAAM,oBACX,QAAQ,GAAG,CAAC,mBAAmB,IAC/B,QAAQ,GAAG,CAAC,YAAY,IACxB;AAaK,SAAS,sBACd,SAAiB,EACjB,kBAAkB,KAAK,KAAK,KAAK,CAAC;IAElC,MAAM,gBAAgB,IAAI,KAAK;IAC/B,MAAM,OAAO,KAAK,KAAK,CAAC,CAAC,cAAc,OAAO,KAAK,KAAK,GAAG,EAAE,IAAI;IACjE,OAAO,OAAO,QAAQ,CAAC,SAAS,OAAO,IAAI,OAAO;AACpD;AAEO,SAAS,oBAAoB,IAAoB;IACtD,IAAI,CAAC,MAAM,OAAO;IAClB,IAAI,CAAC,KAAK,UAAU,CAAC,MAAM,OAAO;IAClC,IAAI,KAAK,UAAU,CAAC,OAAO,OAAO;IAClC,IAAI,KAAK,UAAU,CAAC,UAAU,OAAO;IACrC,OAAO;AACT"}},
    {"offset": {"line": 47, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/apps/web/src/middleware.ts"],"sourcesContent":["import { NextResponse, type NextRequest } from \"next/server\";\n\nimport {\n  AUTH_API_BASE_URL,\n  DEFAULT_AUTH_REDIRECT,\n  SESSION_COOKIE_NAME,\n  type AuthResponse,\n} from \"@/lib/auth\";\n\nconst PUBLIC_PATHS = [\"/auth\", \"/unauthorized\"];\nconst LOGIN_PATH = \"/auth/v2/login\";\n\nexport async function middleware(request: NextRequest) {\n  const { pathname } = request.nextUrl;\n  const isAuthRoute = pathname.startsWith(\"/auth\");\n  const isPublic = isPublicPath(pathname);\n\n  if (pathname.startsWith(\"/api\")) {\n    return NextResponse.next();\n  }\n\n  const sessionToken = request.cookies.get(SESSION_COOKIE_NAME)?.value;\n\n  if (!sessionToken) {\n    return isPublic ? NextResponse.next() : redirectToLogin(request);\n  }\n\n  const session = await validateSession(sessionToken);\n\n  if (!session) {\n    return isPublic ? NextResponse.next() : redirectToLogin(request, true);\n  }\n\n  if (isAuthRoute) {\n    const redirectUrl = new URL(DEFAULT_AUTH_REDIRECT, request.url);\n    const response = NextResponse.redirect(redirectUrl);\n    response.headers.set(\"Cache-Control\", \"no-store\");\n    return response;\n  }\n\n  return NextResponse.next();\n}\n\nasync function validateSession(token: string): Promise<AuthResponse | null> {\n  try {\n    const response = await fetch(`${AUTH_API_BASE_URL}/auth/session`, {\n      method: \"GET\",\n      headers: {\n        Authorization: `Bearer ${token}`,\n      },\n      cache: \"no-store\",\n    });\n\n    if (!response.ok) {\n      return null;\n    }\n\n    return (await response.json()) as AuthResponse;\n  } catch (error) {\n    console.error(\"Failed to validate session\", error);\n    return null;\n  }\n}\n\nfunction isPublicPath(pathname: string) {\n  return PUBLIC_PATHS.some(\n    (path) => pathname === path || pathname.startsWith(`${path}/`),\n  );\n}\n\nfunction redirectToLogin(request: NextRequest, shouldClearCookie = false) {\n  const redirectUrl = new URL(LOGIN_PATH, request.url);\n  const currentPath = `${request.nextUrl.pathname}${request.nextUrl.search}`;\n  if (request.nextUrl.pathname && request.nextUrl.pathname !== LOGIN_PATH) {\n    redirectUrl.searchParams.set(\"redirect\", currentPath);\n  }\n\n  const response = NextResponse.redirect(redirectUrl);\n  response.headers.set(\"Cache-Control\", \"no-store\");\n\n  if (shouldClearCookie) {\n    response.cookies.delete(SESSION_COOKIE_NAME);\n  }\n\n  return response;\n}\n\nexport const config = {\n  matcher: [\"/((?!_next/static|_next/image|favicon.ico|assets).*)\"],\n};\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AAEA;;;AAOA,MAAM,eAAe;IAAC;IAAS;CAAgB;AAC/C,MAAM,aAAa;AAEZ,eAAe,WAAW,OAAoB;IACnD,MAAM,EAAE,QAAQ,EAAE,GAAG,QAAQ,OAAO;IACpC,MAAM,cAAc,SAAS,UAAU,CAAC;IACxC,MAAM,WAAW,aAAa;IAE9B,IAAI,SAAS,UAAU,CAAC,SAAS;QAC/B,OAAO,qZAAY,CAAC,IAAI;IAC1B;IAEA,MAAM,eAAe,QAAQ,OAAO,CAAC,GAAG,CAAC,gKAAmB,GAAG;IAE/D,IAAI,CAAC,cAAc;QACjB,OAAO,WAAW,qZAAY,CAAC,IAAI,KAAK,gBAAgB;IAC1D;IAEA,MAAM,UAAU,MAAM,gBAAgB;IAEtC,IAAI,CAAC,SAAS;QACZ,OAAO,WAAW,qZAAY,CAAC,IAAI,KAAK,gBAAgB,SAAS;IACnE;IAEA,IAAI,aAAa;QACf,MAAM,cAAc,IAAI,IAAI,kKAAqB,EAAE,QAAQ,GAAG;QAC9D,MAAM,WAAW,qZAAY,CAAC,QAAQ,CAAC;QACvC,SAAS,OAAO,CAAC,GAAG,CAAC,iBAAiB;QACtC,OAAO;IACT;IAEA,OAAO,qZAAY,CAAC,IAAI;AAC1B;AAEA,eAAe,gBAAgB,KAAa;IAC1C,IAAI;QACF,MAAM,WAAW,MAAM,MAAM,GAAG,8JAAiB,CAAC,aAAa,CAAC,EAAE;YAChE,QAAQ;YACR,SAAS;gBACP,eAAe,CAAC,OAAO,EAAE,OAAO;YAClC;YACA,OAAO;QACT;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,OAAO;QACT;QAEA,OAAQ,MAAM,SAAS,IAAI;IAC7B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO;IACT;AACF;AAEA,SAAS,aAAa,QAAgB;IACpC,OAAO,aAAa,IAAI,CACtB,CAAC,OAAS,aAAa,QAAQ,SAAS,UAAU,CAAC,GAAG,KAAK,CAAC,CAAC;AAEjE;AAEA,SAAS,gBAAgB,OAAoB,EAAE,oBAAoB,KAAK;IACtE,MAAM,cAAc,IAAI,IAAI,YAAY,QAAQ,GAAG;IACnD,MAAM,cAAc,GAAG,QAAQ,OAAO,CAAC,QAAQ,GAAG,QAAQ,OAAO,CAAC,MAAM,EAAE;IAC1E,IAAI,QAAQ,OAAO,CAAC,QAAQ,IAAI,QAAQ,OAAO,CAAC,QAAQ,KAAK,YAAY;QACvE,YAAY,YAAY,CAAC,GAAG,CAAC,YAAY;IAC3C;IAEA,MAAM,WAAW,qZAAY,CAAC,QAAQ,CAAC;IACvC,SAAS,OAAO,CAAC,GAAG,CAAC,iBAAiB;IAEtC,IAAI,mBAAmB;QACrB,SAAS,OAAO,CAAC,MAAM,CAAC,gKAAmB;IAC7C;IAEA,OAAO;AACT;AAEO,MAAM,SAAS;IACpB,SAAS;QAAC;KAAuD;AACnE"}}]
}